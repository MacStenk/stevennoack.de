---
export const prerender = false;

import { nip19, SimplePool, type Event as NostrEvent } from "nostr-tools";
import { marked } from "marked";

const { id } = Astro.params;

let event: NostrEvent | null = null;
let contentHtml = "";
let error = "";
let title = "Nostr Reader";
let authorName = "Unknown";
let publishedDate = new Date();

const RELAYS = [
    "wss://relay.stevennoack.de",
    "wss://relay.primal.net",
    "wss://nos.lol",
];

if (!id) {
    return Astro.redirect("/nostr");
}

try {
    const pool = new SimplePool();

    // Decode ID and fetch event
    let filter: any = {};
    try {
        const decoded = nip19.decode(id);
        if (decoded.type === "nevent") {
            filter = { ids: [decoded.data.id] };
        } else if (decoded.type === "note") {
            filter = { ids: [decoded.data] };
        } else if (decoded.type === "naddr") {
            filter = {
                kinds: [decoded.data.kind],
                authors: [decoded.data.pubkey],
                "#d": [decoded.data.identifier],
            };
        } else {
            throw new Error("Unsupported ID type: " + decoded.type);
        }
    } catch (e) {
        // If decoding fails, assume it's a raw hex ID
        if (/^[0-9a-f]{64}$/.test(id)) {
            filter = { ids: [id] };
        } else {
            throw new Error("Invalid ID format");
        }
    }

    // Fetch event with timeout
    event = await Promise.race([
        pool.get(RELAYS, filter),
        new Promise<null>((_, reject) =>
            setTimeout(() => reject(new Error("Timeout")), 5000),
        ),
    ]);

    pool.close(RELAYS);

    if (!event) {
        error = "Event not found on relays.";
    } else {
        // Process Event
        const content = event.content;

        // Parse Markdown (marked is safe for our use case)
        let htmlContent = await marked.parse(content);

        // Transform Callouts (Obsidian style > [!INFO])
        // All callouts are collapsed by default for cleaner reading
        htmlContent = htmlContent.replace(
            /<blockquote>\s*<p>\s*\[!(\w+)\](-?)([\s\S]*?)<\/p>([\s\S]*?)<\/blockquote>/gi,
            (match, type, collapsed, titleLine, restContent) => {
                const typeLower = type.toLowerCase();

                // Title is the first line (or part before <br> or \n)
                // If titleLine contains HTML tags like <strong>, keep them
                let titleText = titleLine.trim();

                // If there is content in the first p tag (separated by <br> or \n), append it to restContent
                const splitRegex = /(?:<br\s*\/?>|\n)/i;
                if (splitRegex.test(titleText)) {
                    const parts = titleText.split(splitRegex);
                    titleText = parts[0].trim();
                    // Re-join the rest, replacing newlines with <br> for proper rendering if needed
                    // But usually we just want to keep the rest as is, but we split by regex so we need to be careful.
                    // Actually, simpler: find index of first split match.
                    const firstSeparatorIndex = titleLine.search(splitRegex);
                    if (firstSeparatorIndex !== -1) {
                        titleText = titleLine
                            .substring(0, firstSeparatorIndex)
                            .trim();
                        const contentInP = titleLine
                            .substring(firstSeparatorIndex)
                            .replace(/^(\n|<br\s*\/?>)+/i, "");
                        restContent = contentInP + restContent;
                    }
                }

                // Default title if empty
                if (!titleText || titleText === "<br>") {
                    titleText = type.charAt(0).toUpperCase() + type.slice(1);
                }

                return `<div class="callout callout-${typeLower}">
          <details>
            <summary>${titleText}</summary>
            <div class="callout-content">${restContent}</div>
          </details>
        </div>`;
            },
        );

        contentHtml = htmlContent;

        // Metadata
        const titleTag = event.tags.find((t) => t[0] === "title");
        if (titleTag) {
            title = titleTag[1];
        } else {
            // Fallback: First line of content
            title = content.split("\n")[0].substring(0, 50) + "...";
        }

        // Author (simplified - no profile fetch to save resources)
        authorName = event.pubkey.substring(0, 8) + "...";

        publishedDate = new Date(event.created_at * 1000);
    }
} catch (e) {
    console.error(e);
    error =
        "Error loading event: " + (e instanceof Error ? e.message : String(e));
}

// Schema.org Article
const articleSchema = event
    ? {
          "@context": "https://schema.org",
          "@type": "Article",
          headline: title,
          author: {
              "@type": "Person",
              name: authorName,
          },
          datePublished: publishedDate.toISOString(),
          mainEntityOfPage: {
              "@type": "WebPage",
              "@id": `https://stevennoack.de/nostr/read/${id}`,
          },
      }
    : {};
---

<!doctype html>
<html lang="de">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{title} - Nostr Reader</title>

        <!-- Open Graph -->
        <meta property="og:title" content={title} />
        <meta property="og:type" content="article" />
        <meta
            property="og:url"
            content={`https://stevennoack.de/nostr/read/${id}`}
        />

        {
            event && (
                <>
                    <meta
                        property="article:published_time"
                        content={publishedDate.toISOString()}
                    />
                    <meta property="article:author" content={authorName} />
                    <meta name="nostr:event" content={event.id} />
                </>
            )
        }

        <script
            type="application/ld+json"
            set:html={JSON.stringify(articleSchema)}
        />

        <style is:global>
            @import "../../../styles/nostr-article.css";
        </style>
    </head>
    <body>
        <!-- Font Toggle -->
        <button
            class="font-toggle"
            id="font-toggle"
            aria-label="Schriftart wechseln"
        >
            <span id="font-text">Terminal</span>
        </button>

        <!-- Dark/Light Mode Toggle -->
        <button
            class="mode-toggle"
            id="mode-toggle"
            aria-label="Dark/Light Mode umschalten"
        >
            <span id="mode-icon">‚òÄÔ∏è</span>
            <span id="mode-text">Light</span>
        </button>

        <div class="container">
            <!-- Breadcrumb Navigation -->
            <nav aria-label="Breadcrumb">
                <ol class="breadcrumb">
                    <li><a href="/">Home</a></li>
                    <li class="breadcrumb-separator" aria-hidden="true">‚Üí</li>
                    <li><a href="/nostr">Nostr</a></li>
                    <li class="breadcrumb-separator" aria-hidden="true">‚Üí</li>
                    <li aria-current="page">Reader</li>
                </ol>
            </nav>

            <a href="/nostr" class="back-link">‚Üê Zur√ºck zu Nostr</a>

            {
                error ? (
                    <div class="callout callout-summary">
                        <details open>
                            <summary>Error</summary>
                            <div class="callout-content">
                                <p>{error}</p>
                                <p>ID: {id}</p>
                            </div>
                        </details>
                    </div>
                ) : (
                    <article role="article">
                        <header>
                            <div class="nostr-badge">
                                ‚ö° Live from Nostr
                                <a
                                    href={`https://njump.me/${id}`}
                                    target="_blank"
                                    rel="noopener"
                                >
                                    [Source]
                                </a>
                            </div>

                            <h1>{title}</h1>

                            <div class="post-meta">
                                <time datetime={publishedDate.toISOString()}>
                                    {publishedDate.toLocaleDateString("de-DE", {
                                        year: "numeric",
                                        month: "long",
                                        day: "numeric",
                                        hour: "2-digit",
                                        minute: "2-digit",
                                    })}
                                </time>
                                <span aria-hidden="true">‚Ä¢</span>
                                <span>{authorName}</span>
                            </div>
                        </header>

                        <div class="content" set:html={contentHtml} />

                        <footer>
                            <div class="author-info">
                                <p>Author: {authorName}</p>
                                {event?.pubkey && (
                                    <p class="text-sm text-gray-500">
                                        {event.pubkey}
                                    </p>
                                )}
                            </div>
                        </footer>
                    </article>
                )
            }
        </div>

        <script>
            // Toggle Logic (Copied from [slug].astro or we should extract this too)
            // Since we didn't extract the JS, we'll inline it here for now.
            // Ideally this should be in a shared script or layout.

            const modeToggle = document.getElementById("mode-toggle");
            const modeIcon = document.getElementById("mode-icon");
            const modeText = document.getElementById("mode-text");
            const body = document.body;

            // Check local storage
            const currentMode = localStorage.getItem("theme");
            if (currentMode === "light") {
                body.classList.add("light-mode");
                modeIcon.textContent = "üåô";
                modeText.textContent = "Dark";
            }

            modeToggle?.addEventListener("click", () => {
                body.classList.toggle("light-mode");
                const isLight = body.classList.contains("light-mode");
                localStorage.setItem("theme", isLight ? "light" : "dark");
                modeIcon.textContent = isLight ? "üåô" : "‚òÄÔ∏è";
                modeText.textContent = isLight ? "Dark" : "Light";
            });

            const fontToggle = document.getElementById("font-toggle");
            const fontText = document.getElementById("font-text");
            const fonts = ["Terminal", "Sans", "Serif"];
            let currentFontIndex = 0;

            // Check local storage
            const savedFont = localStorage.getItem("font");
            if (savedFont) {
                if (savedFont === "sans") {
                    body.classList.add("font-sans");
                    currentFontIndex = 1;
                    fontText.textContent = "Sans";
                } else if (savedFont === "serif") {
                    body.classList.add("font-serif");
                    currentFontIndex = 2;
                    fontText.textContent = "Serif";
                }
            }

            fontToggle?.addEventListener("click", () => {
                currentFontIndex = (currentFontIndex + 1) % fonts.length;
                const font = fonts[currentFontIndex];

                body.classList.remove("font-sans", "font-serif");

                if (font === "Sans") {
                    body.classList.add("font-sans");
                    localStorage.setItem("font", "sans");
                } else if (font === "Serif") {
                    body.classList.add("font-serif");
                    localStorage.setItem("font", "serif");
                } else {
                    localStorage.setItem("font", "terminal");
                }

                fontText.textContent = font;
            });
        </script>
    </body>
</html>
