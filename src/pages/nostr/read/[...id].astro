---
export const prerender = false;

import { nip19, SimplePool, type Event as NostrEvent } from "nostr-tools";
import { marked } from "marked";
import unlockContentUrl from "../../../scripts/unlock-content.js?url";
import NostrClientPicker from "../../../components/NostrClientPicker.astro";

const { id } = Astro.params;

let event: NostrEvent | null = null;
let profileEvent: NostrEvent | null = null;
let isProfile = false;
let contentHtml = "";
let error = "";
let title = "Nostr Reader";
let summary = "";
let authorName = "Unknown";
let authorPicture = "";
let authorNpub = "";
let authorLightning = "";
let authorNip05 = "";
let authorAbout = "";
let authorWebsite = "";
let publishedDate = new Date();
let heroImage = "";
let eventId = "";
let nevent = "";
let naddr = "";
let dTag = "";
let tags: string[] = [];
let wordCount = 0;
let readingTime = 0;

// Profile specific
let profilePubkey = "";
let profileCode = "";

// Profile Phase 2
let followingCount: number | null = null;
let followersCount: string = "—";
let notesEvents: NostrEvent[] = [];
let articleEvents: NostrEvent[] = [];
let mediaEvents: NostrEvent[] = [];

const RELAYS = [
    "wss://relay.stevennoack.de",
    "wss://relay.primal.net",
    "wss://nos.lol",
    "wss://relay.damus.io",
    "wss://relay.nostr.band",
];

const SITE_URL = "https://stevennoack.de";
const SITE_NAME = "Steven Noack";

function getTagValue(ev: NostrEvent, name: string): string {
    const t = ev.tags.find((x) => x[0] === name);
    return t?.[1] || "";
}

function getFirstLine(text: string): string {
    const line = (text || "").split("\n").map((l) => l.trim()).find(Boolean);
    return line || "";
}

function formatDate(ts: number): string {
    return new Date(ts * 1000).toLocaleDateString("de-DE", {
        year: "numeric",
        month: "short",
        day: "2-digit",
    });
}

function formatRelativeTime(tsSeconds: number): string {
    const diffMs = Date.now() - tsSeconds * 1000;
    const diffSec = Math.max(0, Math.floor(diffMs / 1000));

    const min = Math.floor(diffSec / 60);
    const hr = Math.floor(min / 60);
    const day = Math.floor(hr / 24);

    if (diffSec < 60) return `${diffSec}s ago`;
    if (min < 60) return `${min}m ago`;
    if (hr < 24) return `${hr}h ago`;
    if (day < 7) return `${day}d ago`;

    // fallback: show date for older posts
    return formatDate(tsSeconds);
}

function estimateReadingTimeMinutes(text: string): number {
    const plainText = (text || "").replace(/[#*`>\[\]()]|\s+/g, " ").trim();
    const wc = plainText ? plainText.split(" ").filter(Boolean).length : 0;
    return Math.max(1, Math.ceil(wc / 200));
}

function eventPermalink(ev: NostrEvent): string {
    // Prefer naddr for addressable events (like kind 30023)
    const d = getTagValue(ev, "d");
    if (d) {
        try {
            const code = nip19.naddrEncode({
                kind: ev.kind,
                pubkey: ev.pubkey,
                identifier: d,
                relays: RELAYS,
            });
            return `/nostr/read/${code}`;
        } catch {
            // fallthrough
        }
    }

    try {
        const code = nip19.neventEncode({ id: ev.id, author: ev.pubkey, relays: RELAYS });
        return `/nostr/read/${code}`;
    } catch {
        return `/nostr/read/${ev.id}`;
    }
}

if (!id) {
    return Astro.redirect("/nostr");
}

try {
    const pool = new SimplePool();

    // Decode ID
    let filter: any = {};

    try {
        const decoded = nip19.decode(id);

        if (decoded.type === "npub") {
            isProfile = true;
            profilePubkey = decoded.data;
            profileCode = nip19.npubEncode(profilePubkey);
            filter = { kinds: [0], authors: [profilePubkey] };
        } else if (decoded.type === "nprofile") {
            isProfile = true;
            profilePubkey = decoded.data.pubkey;
            profileCode = id;
            filter = { kinds: [0], authors: [profilePubkey] };
        } else if (decoded.type === "nevent") {
            filter = { ids: [decoded.data.id] };
        } else if (decoded.type === "note") {
            filter = { ids: [decoded.data] };
        } else if (decoded.type === "naddr") {
            filter = {
                kinds: [decoded.data.kind],
                authors: [decoded.data.pubkey],
                "#d": [decoded.data.identifier],
            };
        } else {
            throw new Error("Unsupported ID type: " + decoded.type);
        }
    } catch (e) {
        // If decoding fails, assume it's a raw hex ID (event)
        if (/^[0-9a-f]{64}$/.test(id)) {
            filter = { ids: [id] };
        } else {
            throw new Error("Invalid ID format");
        }
    }

    if (isProfile) {
        // Fetch kind 0 profile metadata with timeout (10s, relays can be slow)
        profileEvent = await Promise.race([
            pool.get(RELAYS, filter),
            new Promise<null>((_, reject) =>
                setTimeout(() => reject(new Error("Timeout")), 10000),
            ),
        ]);

        if (!profileEvent) {
            pool.close(RELAYS);
            error = "Profile not found on relays.";
        } else {
            // Parse profile
            try {
                const profile = JSON.parse(profileEvent.content || "{}");
                authorName = profile.display_name || profile.name || profile.username || "Unknown";
                authorPicture = profile.picture || "";
                authorLightning = profile.lud16 || profile.lud06 || "";
                authorNip05 = profile.nip05 || "";
                authorAbout = profile.about || "";
                authorWebsite = profile.website || "";
            } catch (profileParseError) {
                console.error("Profile parse error:", profileParseError);
            }

            authorNpub = nip19.npubEncode(profilePubkey);
            title = `${authorName} - Profil`;
            summary = authorAbout;
            publishedDate = new Date(profileEvent.created_at * 1000);

            // Phase 2: Following count (kind 3 contact list)
            try {
                const contactList = await Promise.race([
                    pool.get(RELAYS, { kinds: [3], authors: [profilePubkey] }),
                    new Promise<null>((_, reject) =>
                        setTimeout(() => reject(new Error("Timeout")), 10000),
                    ),
                ]);

                if (contactList) {
                    followingCount = contactList.tags.filter((t) => t[0] === "p").length;
                }
            } catch (e) {
                console.error("Contact list fetch error:", e);
            }

            // Phase 2: Profile content for tabs (SSR fetch, switching is client-side)
            try {
                const [notes, articles] = await Promise.race([
                    Promise.all([
                        pool.querySync(RELAYS, { kinds: [1], authors: [profilePubkey], limit: 20 }),
                        pool.querySync(RELAYS, { kinds: [30023], authors: [profilePubkey], limit: 20 })
                    ]),
                    new Promise<[NostrEvent[], NostrEvent[]]>((_, reject) =>
                        setTimeout(() => reject(new Error("Timeout")), 10000)
                    )
                ]);

                notesEvents = (notes || []).sort((a, b) => (b.created_at || 0) - (a.created_at || 0)).slice(0, 20);
                articleEvents = (articles || []).sort((a, b) => (b.created_at || 0) - (a.created_at || 0)).slice(0, 20);
            } catch (e) {
                console.error("Profile content fetch error:", e);
            }

            // Media is optional for now
            mediaEvents = [];

            pool.close(RELAYS);
        }
    } else {
        // Fetch event with timeout (10s, relays can be slow)
        event = await Promise.race([
            pool.get(RELAYS, filter),
            new Promise<null>((_, reject) =>
                setTimeout(() => reject(new Error("Timeout")), 10000),
            ),
        ]);

        if (!event) {
            pool.close(RELAYS);
            error = "Event not found on relays.";
        } else {
            // Store event ID
            eventId = event.id;

            // Generate nevent
            nevent = nip19.neventEncode({
                id: event.id,
                author: event.pubkey,
                relays: RELAYS,
            });

            // Get d-tag for naddr
            const dTagEntry = event.tags.find((t) => t[0] === "d");
            if (dTagEntry) {
                dTag = dTagEntry[1];
                // Generate naddr
                naddr = nip19.naddrEncode({
                    kind: event.kind,
                    pubkey: event.pubkey,
                    identifier: dTag,
                    relays: RELAYS,
                });
            }

            // Get summary
            const summaryTag = event.tags.find((t) => t[0] === "summary");
            if (summaryTag) {
                summary = summaryTag[1];
            }

            // Get tags/keywords
            const tTags = event.tags.filter((t) => t[0] === "t");
            tags = tTags.map((t) => t[1]);

            // Fetch author profile (kind 0)
            try {
                const profileEventInner = await Promise.race([
                    pool.get(RELAYS, { kinds: [0], authors: [event.pubkey] }),
                    new Promise<null>((resolve) => setTimeout(() => resolve(null), 3000)),
                ]);

                if (profileEventInner) {
                    const profile = JSON.parse(profileEventInner.content);
                    authorName = profile.display_name || profile.name || profile.username || "Unknown";
                    authorPicture = profile.picture || "";
                    authorLightning = profile.lud16 || profile.lud06 || "";
                    authorNip05 = profile.nip05 || "";
                    authorAbout = profile.about || "";
                    authorWebsite = profile.website || "";
                } else {
                    // Fallback: show shortened pubkey
                    authorName = event.pubkey.substring(0, 8) + "...";
                }
            } catch (profileError) {
                // Profile fetch failed, use fallback
                console.error("Profile fetch error:", profileError);
                authorName = event.pubkey.substring(0, 8) + "...";
            }

            // Generate npub for author link
            authorNpub = nip19.npubEncode(event.pubkey);

            pool.close(RELAYS);

            // Process Event
            const content = event.content;

            // Calculate word count and reading time
            const plainText = content.replace(/[#*`>\[\]()]/g, '');
            wordCount = plainText.split(/\s+/).filter(word => word.length > 0).length;
            readingTime = Math.ceil(wordCount / 200); // ~200 words per minute

            // Parse Markdown (marked is safe for our use case)
            let htmlContent = await marked.parse(content);

            // Transform Callouts (Obsidian style > [!INFO])
            htmlContent = htmlContent.replace(
                /<blockquote>\s*<p>\s*\[!(\w+)\](-?)([\s\S]*?)<\/p>([\s\S]*?)<\/blockquote>/gi,
                (match, type, collapsed, titleLine, restContent) => {
                    const typeLower = type.toLowerCase();
                    let titleText = titleLine.trim();
                    const splitRegex = /(?:<br\s*\/?>|\n)/i;
                    if (splitRegex.test(titleText)) {
                        const firstSeparatorIndex = titleLine.search(splitRegex);
                        if (firstSeparatorIndex !== -1) {
                            titleText = titleLine.substring(0, firstSeparatorIndex).trim();
                            const contentInP = titleLine
                                .substring(firstSeparatorIndex)
                                .replace(/^(\n|<br\s*\/?>)+/i, "");
                            restContent = contentInP + restContent;
                        }
                    }
                    if (!titleText || titleText === "<br>") {
                        titleText = type.charAt(0).toUpperCase() + type.slice(1);
                    }
                    return `<div class="callout callout-${typeLower}">
                        <details>
                            <summary>${titleText}</summary>
                            <div class="callout-content">${restContent}</div>
                        </details>
                    </div>`;
                },
            );

            contentHtml = htmlContent;

            // Metadata
            const titleTag = event.tags.find((t) => t[0] === "title");
            if (titleTag) {
                title = titleTag[1];
            } else {
                title = content.split("\n")[0].substring(0, 50) + "...";
            }

            const imageTag = event.tags.find((t) => t[0] === "image");
            if (imageTag) {
                heroImage = imageTag[1];
            }

            publishedDate = new Date(event.created_at * 1000);
        }
    }
} catch (e) {
    console.error(e);
    error = "Error loading event: " + (e instanceof Error ? e.message : String(e));
}

// ============================================
// COMPREHENSIVE SCHEMA.ORG + KNOWLEDGE GRAPH
// ============================================

const pageUrl = `${SITE_URL}/nostr/read/${id}`;
const ogType = isProfile ? "profile" : "article";

// Person Schema (Author) - Umfangreich mit Nostr-Identifikatoren
const authorSchema = {
    "@type": "Person",
    "@id": `${SITE_URL}/#author-${authorNpub}`,
    name: authorName,
    image: authorPicture || undefined,
    description: authorAbout || undefined,
    url: authorWebsite || `${SITE_URL}/nostr`,
    identifier: [
        {
            "@type": "PropertyValue",
            propertyID: "nostr:npub",
            value: authorNpub,
        },
        authorNip05 ? {
            "@type": "PropertyValue",
            propertyID: "nostr:nip05",
            value: authorNip05,
        } : null,
    ].filter(Boolean),
    sameAs: [
        `https://njump.me/${authorNpub}`,
        authorWebsite || null,
    ].filter(Boolean),
};

// Profile Schema (when viewing a kind 0 profile)
const profileSchema = isProfile ? {
    "@type": "Person",
    "@id": `${pageUrl}#person`,
    name: authorName,
    image: authorPicture || undefined,
    description: authorAbout || undefined,
    url: authorWebsite || undefined,
    mainEntityOfPage: { "@id": pageUrl },
    identifier: [
        {
            "@type": "PropertyValue",
            propertyID: "nostr:npub",
            value: authorNpub,
        },
        authorNip05 ? {
            "@type": "PropertyValue",
            propertyID: "nostr:nip05",
            value: authorNip05,
        } : null,
    ].filter(Boolean),
    sameAs: [
        `https://njump.me/${profileCode || authorNpub}`,
        authorWebsite || null,
    ].filter(Boolean),
} : null;

// Organization Schema (Publisher)
const publisherSchema = {
    "@type": "Organization",
    "@id": `${SITE_URL}/#organization`,
    name: SITE_NAME,
    url: SITE_URL,
    logo: {
        "@type": "ImageObject",
        url: `${SITE_URL}/favicon.svg`,
        width: 512,
        height: 512,
    },
    sameAs: [
        "https://njump.me/npub1cxa0fa6vmq5evwpgk8dg6ul99ny5e2nd3hy5fa72g598t39nxy0surzuva",
        "https://github.com/MacStenk",
    ],
};

// ImageObject Schema (Hero Image)
const imageSchema = heroImage ? {
    "@type": "ImageObject",
    "@id": `${pageUrl}/#primaryimage`,
    url: heroImage,
    contentUrl: heroImage,
    caption: title,
    representativeOfPage: true,
} : null;

// BreadcrumbList Schema
const breadcrumbSchema = {
    "@type": "BreadcrumbList",
    "@id": `${pageUrl}/#breadcrumb`,
    itemListElement: [
        {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: SITE_URL,
        },
        {
            "@type": "ListItem",
            position: 2,
            name: "Nostr",
            item: `${SITE_URL}/nostr`,
        },
        {
            "@type": "ListItem",
            position: 3,
            name: title,
            item: pageUrl,
        },
    ],
};

// WebPage Schema
const webPageSchema = {
    "@type": "WebPage",
    "@id": pageUrl,
    url: pageUrl,
    name: `${title} - Nostr Reader`,
    description: summary || `${title} von ${authorName}`,
    isPartOf: {
        "@id": `${SITE_URL}/#website`,
    },
    primaryImageOfPage: imageSchema ? { "@id": `${pageUrl}/#primaryimage` } : undefined,
    breadcrumb: { "@id": `${pageUrl}/#breadcrumb` },
    inLanguage: "de-DE",
    potentialAction: [
        {
            "@type": "ReadAction",
            target: [pageUrl],
        },
    ],
};

// Website Schema
const websiteSchema = {
    "@type": "WebSite",
    "@id": `${SITE_URL}/#website`,
    url: SITE_URL,
    name: SITE_NAME,
    description: "Dekonditionierung. Für Mensch und Maschine.",
    publisher: { "@id": `${SITE_URL}/#organization` },
    inLanguage: "de-DE",
};

// Main Article Schema - Sehr umfangreich
const articleSchema = event && !isProfile ? {
    "@type": "Article",
    "@id": `${pageUrl}/#article`,
    headline: title,
    name: title,
    description: summary || undefined,
    image: imageSchema ? { "@id": `${pageUrl}/#primaryimage` } : undefined,
    author: { "@id": `${SITE_URL}/#author-${authorNpub}` },
    publisher: { "@id": `${SITE_URL}/#organization` },
    datePublished: publishedDate.toISOString(),
    dateModified: publishedDate.toISOString(),
    dateCreated: publishedDate.toISOString(),
    mainEntityOfPage: { "@id": pageUrl },
    isPartOf: { "@id": `${SITE_URL}/#website` },
    inLanguage: "de-DE",
    wordCount: wordCount,
    timeRequired: `PT${readingTime}M`,
    keywords: tags.length > 0 ? tags.join(", ") : undefined,
    articleSection: "Nostr",
    isAccessibleForFree: true,
    license: "https://creativecommons.org/licenses/by/4.0/",
    copyrightYear: publishedDate.getFullYear(),
    copyrightHolder: { "@id": `${SITE_URL}/#author-${authorNpub}` },
    
    // Nostr-spezifische Identifier
    identifier: [
        {
            "@type": "PropertyValue",
            propertyID: "nostr:nevent",
            value: nevent,
        },
        naddr ? {
            "@type": "PropertyValue",
            propertyID: "nostr:naddr",
            value: naddr,
        } : null,
        {
            "@type": "PropertyValue",
            propertyID: "nostr:eventId",
            value: eventId,
        },
        dTag ? {
            "@type": "PropertyValue",
            propertyID: "nostr:d-tag",
            value: dTag,
        } : null,
    ].filter(Boolean),
    
    // Verknüpfung zur externen Verifizierung
    sameAs: [
        `https://njump.me/${naddr || nevent}`,
        `https://habla.news/a/${naddr}`,
    ].filter(Boolean),
    
    // Relays als distribution
    distribution: RELAYS.map(relay => ({
        "@type": "DataDownload",
        contentUrl: relay,
        encodingFormat: "application/json",
        description: `Nostr Relay: ${relay}`,
    })),
} : null;

// Combined Graph
const schemaGraph = {
    "@context": "https://schema.org",
    "@graph": [
        websiteSchema,
        publisherSchema,
        authorSchema,
        profileSchema,
        imageSchema,
        breadcrumbSchema,
        webPageSchema,
        articleSchema,
    ].filter(Boolean),
};

// Open Graph Tags erweitert
const ogTags = {
    title: title,
    type: "article",
    url: pageUrl,
    image: heroImage,
    description: summary,
    siteName: SITE_NAME,
    locale: "de_DE",
    publishedTime: publishedDate.toISOString(),
    modifiedTime: publishedDate.toISOString(),
    author: authorName,
    section: "Nostr",
    tags: tags,
};
---

<!doctype html>
<html lang="de">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{title} - Nostr Reader</title>
        
        <!-- Primary Meta Tags -->
        <meta name="title" content={`${title} - Nostr Reader`} />
        <meta name="description" content={summary || `${title} von ${authorName}`} />
        <meta name="author" content={authorName} />
        <meta name="keywords" content={tags.join(", ")} />
        <meta name="robots" content="index, follow" />
        
        <!-- Canonical - Static page is the source for Google -->
        {dTag ? (
            <link rel="canonical" href={`${SITE_URL}/nostr/artikel/${dTag}`} />
        ) : (
            <link rel="canonical" href={pageUrl} />
        )}

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content={ogType} />
        <meta property="og:url" content={pageUrl} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={summary || `${title} von ${authorName}`} />
        <meta property="og:site_name" content={SITE_NAME} />
        <meta property="og:locale" content="de_DE" />
        {heroImage && <meta property="og:image" content={heroImage} />}
        {heroImage && <meta property="og:image:alt" content={title} />}
        
        <!-- Article specific OG omitted -->

        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:url" content={pageUrl} />
        <meta name="twitter:title" content={title} />
        <meta name="twitter:description" content={summary || `${title} von ${authorName}`} />
        {heroImage && <meta name="twitter:image" content={heroImage} />}

        <!-- Nostr Metadata -->
        {event && !isProfile && (
            <>
                <meta name="nostr:event" content={eventId} />
                <meta name="nostr:nevent" content={nevent} />
                {naddr && <meta name="nostr:naddr" content={naddr} />}
                <meta name="nostr:author" content={authorNpub} />
                {authorNip05 && <meta name="nostr:nip05" content={authorNip05} />}
            </>
        )}

        {isProfile && (
            <>
                <meta name="nostr:kind" content="0" />
                <meta name="nostr:author" content={authorNpub} />
                {authorNip05 && <meta name="nostr:nip05" content={authorNip05} />}
            </>
        )}

        <!-- Schema.org JSON-LD -->
        <script
            type="application/ld+json"
            set:html={JSON.stringify(schemaGraph)}
        />

        <style is:global>
            @import "../../../styles/nostr-article.css";

            /* Badge Styles */
            .badge {
                display: inline-flex;
                align-items: center;
                gap: 0.4rem;
                padding: 0.25rem 0.6rem;
                font-size: 0.75rem;
                font-family: monospace;
                border: 1px solid rgba(0, 212, 255, 0.3);
                border-radius: 4px;
                background: transparent;
                color: #00d4ff;
                text-decoration: none;
                transition: all 0.2s ease;
                cursor: pointer;
            }

            .badge:hover {
                border-color: #00d4ff;
                background: rgba(0, 212, 255, 0.1);
            }

            .badge-zap {
                border-color: rgba(255, 200, 0, 0.4);
                color: #ffc800;
            }

            .badge-zap:hover {
                border-color: #ffc800;
                background: rgba(255, 200, 0, 0.1);
            }

            /* Author Card Styles */
            .author-card {
                display: flex;
                align-items: center;
                gap: 1rem;
                padding: 1rem;
                background: rgba(0, 212, 255, 0.05);
                border: 1px solid rgba(0, 212, 255, 0.2);
                border-radius: 8px;
                margin-top: 2rem;
                text-decoration: none;
            }

            .author-card:hover {
                border-color: rgba(0, 212, 255, 0.4);
            }

            .author-avatar {
                width: 64px;
                height: 64px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid rgba(0, 212, 255, 0.3);
            }

            .author-avatar-placeholder {
                width: 64px;
                height: 64px;
                border-radius: 50%;
                background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
                color: white;
                font-weight: bold;
            }

            .author-details {
                flex: 1;
            }

            .author-name {
                font-size: 1.1rem;
                font-weight: 600;
                color: #00d4ff;
                margin: 0 0 0.25rem 0;
            }

            .author-npub {
                font-size: 0.75rem;
                color: #666;
                font-family: monospace;
                word-break: break-all;
            }

            /* Verification Section */
            .verification-section {
                margin-top: 1.5rem;
                padding: 1rem;
                border: 1px solid rgba(0, 212, 255, 0.15);
                border-radius: 8px;
                background: rgba(0, 0, 0, 0.2);
            }

            .verification-header {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-bottom: 1rem;
                font-size: 0.8rem;
                color: #00d4ff;
                font-family: monospace;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .verification-grid {
                display: grid;
                gap: 0.75rem;
            }

            .verification-row {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                gap: 0.5rem;
            }

            .verification-label {
                font-size: 0.7rem;
                color: #666;
                font-family: monospace;
                text-transform: uppercase;
                min-width: 60px;
            }

            .verification-value {
                font-size: 0.75rem;
                color: #888;
                font-family: monospace;
                word-break: break-all;
                flex: 1;
            }

            .verification-badges {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                margin-top: 1rem;
            }

            /* Meta author inline */
            .post-meta .author-inline {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }

            .post-meta .author-inline img {
                width: 24px;
                height: 24px;
                border-radius: 50%;
                object-fit: cover;
            }

            .post-meta-row {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                gap: 0.75rem;
            }

            /* Reading time badge */
            .reading-time {
                font-size: 0.8rem;
                color: #666;
            }

            .light-mode .author-card {
                background: rgba(0, 150, 200, 0.05);
                border-color: rgba(0, 150, 200, 0.2);
            }

            .light-mode .author-npub {
                color: #888;
            }

            .light-mode .verification-section {
                background: rgba(0, 0, 0, 0.03);
                border-color: rgba(0, 150, 200, 0.15);
            }

            .light-mode .verification-value {
                color: #555;
            }

            .light-mode .badge {
                border-color: rgba(0, 150, 200, 0.4);
                color: #0099aa;
            }

            .light-mode .badge:hover {
                border-color: #0099aa;
                background: rgba(0, 150, 200, 0.1);
            }

            .light-mode .badge-zap {
                border-color: rgba(200, 150, 0, 0.4);
                color: #b38f00;
            }

            .light-mode .badge-zap:hover {
                border-color: #b38f00;
                background: rgba(200, 150, 0, 0.1);
            }

            /* License Section */
            .license-section {
                margin-top: 1.5rem;
                padding-top: 1rem;
                border-top: 1px solid rgba(0, 212, 255, 0.1);
            }

            .badge-license {
                border-color: rgba(100, 200, 100, 0.4);
                color: #64c864;
            }

            .badge-license:hover {
                border-color: #64c864;
                background: rgba(100, 200, 100, 0.1);
            }

            .license-text {
                margin-top: 0.75rem;
                font-size: 0.75rem;
                color: #666;
                line-height: 1.5;
            }

            .light-mode .badge-license {
                border-color: rgba(80, 160, 80, 0.4);
                color: #4a9a4a;
            }

            .light-mode .badge-license:hover {
                border-color: #4a9a4a;
                background: rgba(80, 160, 80, 0.1);
            }

            .light-mode .license-text {
                color: #555;
            }

            /* Profile Phase 2: stats + tabs + content cards */
            .profile-stats {
                font-size: 0.85rem;
                color: #888;
            }

            .profile-tabs {
                display: flex;
                gap: 1.25rem;
                border-bottom: 1px solid rgba(0, 212, 255, 0.15);
            }

            .tab-button {
                appearance: none;
                background: transparent;
                border: 0;
                padding: 0.6rem 0;
                color: #888;
                cursor: pointer;
                font-size: 0.95rem;
                font-family: inherit;
                border-bottom: 2px solid transparent;
            }

            .tab-button:hover {
                color: #00d4ff;
            }

            .tab-button.is-active {
                color: #00d4ff;
                border-bottom-color: #00d4ff;
            }

            .content-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
                gap: 0.75rem;
            }

            .content-card {
                display: block;
                text-decoration: none;
                padding: 0.9rem;
                border-radius: 10px;
                border: 1px solid rgba(0, 212, 255, 0.15);
                background: rgba(0, 212, 255, 0.03);
                transition: border-color 0.15s ease, background 0.15s ease;
                color: inherit;
                overflow: hidden;
            }

            .content-card:hover {
                border-color: rgba(0, 212, 255, 0.35);
                background: rgba(0, 212, 255, 0.06);
            }

            .content-card-hero {
                margin: -0.9rem -0.9rem 0.75rem -0.9rem;
                height: 140px;
                overflow: hidden;
                border-bottom: 1px solid rgba(0, 212, 255, 0.12);
            }

            .content-card-hero img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

            .content-card-title {
                font-weight: 600;
                color: #00d4ff;
                line-height: 1.35;
                margin: 0 0 0.4rem 0;
            }

            .content-card-meta {
                font-size: 0.75rem;
                color: #777;
                font-family: monospace;
            }

            .content-empty {
                padding: 1rem;
                border-radius: 10px;
                border: 1px dashed rgba(0, 212, 255, 0.2);
                color: #777;
                background: rgba(0, 0, 0, 0.15);
            }

            .light-mode .profile-stats {
                color: #666;
            }

            .light-mode .tab-button {
                color: #666;
            }

            .light-mode .content-card {
                background: rgba(0, 150, 200, 0.03);
                border-color: rgba(0, 150, 200, 0.18);
            }

            .light-mode .content-card-title {
                color: #007f99;
            }

            .light-mode .content-empty {
                background: rgba(0, 0, 0, 0.03);
                color: #555;
            }
        </style>
      <!-- Umami Analytics -->
    <script defer src="https://stats.stevennoack.de/script.js" data-website-id="95066d20-b614-4852-85b0-673af1e2eed1"></script>
  </head>
    <body>
        <!-- Font Toggle -->
        <button
            class="font-toggle"
            id="font-toggle"
            aria-label="Schriftart wechseln"
        >
            <span id="font-text">Terminal</span>
        </button>

        <!-- Dark/Light Mode Toggle -->
        <button
            class="mode-toggle"
            id="mode-toggle"
            aria-label="Dark/Light Mode umschalten"
        >
            <span id="mode-icon">☀️</span>
            <span id="mode-text">Light</span>
        </button>

        <div class="container">
            <!-- Breadcrumb Navigation -->
            <nav aria-label="Breadcrumb">
                <ol class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
                    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                        <a itemprop="item" href="/"><span itemprop="name">Home</span></a>
                        <meta itemprop="position" content="1" />
                    </li>
                    <li class="breadcrumb-separator" aria-hidden="true">→</li>
                    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                        <a itemprop="item" href="/nostr"><span itemprop="name">Nostr</span></a>
                        <meta itemprop="position" content="2" />
                    </li>
                    <li class="breadcrumb-separator" aria-hidden="true">→</li>
                    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" aria-current="page">
                        <span itemprop="name">Reader</span>
                        <meta itemprop="position" content="3" />
                    </li>
                </ol>
            </nav>

            <a href="/nostr" class="back-link">← Zurück zu Nostr</a>

            {
                error ? (
                    <div class="callout callout-summary">
                        <details open>
                            <summary>Error</summary>
                            <div class="callout-content">
                                <p>{error}</p>
                                <p>ID: {id}</p>
                            </div>
                        </details>
                    </div>
                ) : (isProfile ? (
                        <main role="main" class="profile" itemscope itemtype="https://schema.org/Person">
                            <header>
                                <div class="author-card" style="margin-top: 0;">
                                    {authorPicture ? (
                                        <img
                                            src={authorPicture}
                                            alt={authorName}
                                            class="author-avatar"
                                            itemprop="image"
                                        />
                                    ) : (
                                        <div class="author-avatar-placeholder" aria-hidden="true">
                                            {authorName.charAt(0).toUpperCase()}
                                        </div>
                                    )}
                                    <div class="author-details">
                                        <h1 class="author-name" itemprop="name" style="margin: 0 0 0.25rem 0;">
                                            {authorName}
                                        </h1>
                                        <p class="author-npub" style="margin: 0;">{authorNpub}</p>
                                    </div>
                                </div>

                                <div class="post-meta" style="margin-top: 1rem;">
                                    <div class="post-meta-row">
                                        <time datetime={publishedDate.toISOString()}>
                                            {publishedDate.toLocaleDateString("de-DE", {
                                                year: "numeric",
                                                month: "long",
                                                day: "numeric",
                                                hour: "2-digit",
                                                minute: "2-digit",
                                            })}
                                        </time>
                                        {authorNip05 && (
                                            <span class="badge" title="NIP-05">{authorNip05}</span>
                                        )}
                                        {authorWebsite && (
                                            <a
                                                href={authorWebsite}
                                                target="_blank"
                                                rel="noopener"
                                                class="badge"
                                                itemprop="url"
                                            >
                                                Website
                                            </a>
                                        )}
                                    </div>
                                </div>

                                <div class="verification-badges" style="margin-top: 1rem;">
                                    {authorLightning && (
                                        <a
                                            href={`lightning:${authorLightning}`}
                                            class="badge badge-zap"
                                            title={`Zap an ${authorLightning}`}
                                        >
                                            Zap
                                        </a>
                                    )}
                                    <button
                                        class="badge"
                                        data-copy={authorNpub}
                                        onclick="navigator.clipboard.writeText(this.dataset.copy); this.textContent = 'Kopiert!'; setTimeout(() => this.textContent = 'npub kopieren', 2000)"
                                    >
                                        npub kopieren
                                    </button>
                                    <NostrClientPicker code={profileCode || authorNpub} kind={0} />
                                </div>
                            </header>

                            {authorAbout && (
                                <section class="verification-section" style="margin-top: 1.5rem;">
                                    <div class="verification-header">
                                        <span>Über</span>
                                    </div>
                                    <div class="content">
                                        <p itemprop="description" style="margin: 0; white-space: pre-wrap;">{authorAbout}</p>
                                    </div>
                                </section>
                            )}

                            <div class="profile-stats" style="margin-top: 0.75rem;">
                                <span>
                                    {(followingCount ?? "—")} Following <span aria-hidden="true">·</span> {followersCount} Followers
                                </span>
                            </div>

                            <div class="profile-tabs" style="margin-top: 1.25rem;">
                                <button class="tab-button is-active" type="button" data-tab="notes">Notes</button>
                                <button class="tab-button" type="button" data-tab="articles">Articles</button>
                                <button class="tab-button" type="button" data-tab="media">Media</button>
                                <button class="tab-button" type="button" data-tab="others">Others</button>
                            </div>

                            <section class="tab-panel" data-panel="notes" style="margin-top: 1rem;">
                                <div class="content-grid">
                                    {notesEvents.length > 0 ? (
                                        notesEvents.map((e) => (
                                            <a class="content-card" href={eventPermalink(e)}>
                                                <div class="content-card-title">
                                                    {getFirstLine(e.content).substring(0, 140) || "(ohne Text)"}
                                                </div>
                                                <div class="content-card-meta">
                                                    <time datetime={new Date(e.created_at * 1000).toISOString()}>
                                                        {formatDate(e.created_at)}
                                                    </time>
                                                </div>
                                            </a>
                                        ))
                                    ) : (
                                        <div class="content-empty">Keine Notes gefunden.</div>
                                    )}
                                </div>
                            </section>

                            <section class="tab-panel" data-panel="articles" hidden style="margin-top: 1rem;">
                                <div class="content-grid">
                                    {articleEvents.length > 0 ? (
                                        articleEvents.map((e) => {
                                            const aTitle = getTagValue(e, "title") || getFirstLine(e.content) || "Untitled";
                                            const aImage = getTagValue(e, "image");
                                            return (
                                                <a class="content-card" href={eventPermalink(e)}>
                                                    {aImage && (
                                                        <div class="content-card-hero">
                                                            <img src={aImage} alt={aTitle} loading="lazy" />
                                                        </div>
                                                    )}
                                                    <div class="content-card-title">{aTitle}</div>
                                                    <div class="content-card-meta">
                                                        <time datetime={new Date(e.created_at * 1000).toISOString()}>
                                                            {formatDate(e.created_at)}
                                                        </time>
                                                    </div>
                                                </a>
                                            );
                                        })
                                    ) : (
                                        <div class="content-empty">Keine Articles gefunden.</div>
                                    )}
                                </div>
                            </section>

                            <section class="tab-panel" data-panel="media" hidden style="margin-top: 1rem;">
                                <div class="content-grid">
                                    {mediaEvents.length > 0 ? (
                                        mediaEvents.map((e) => (
                                            <a class="content-card" href={eventPermalink(e)}>
                                                <div class="content-card-title">
                                                    {getTagValue(e, "title") || getFirstLine(e.content) || "Media"}
                                                </div>
                                                <div class="content-card-meta">
                                                    <time datetime={new Date(e.created_at * 1000).toISOString()}>
                                                        {formatDate(e.created_at)}
                                                    </time>
                                                </div>
                                            </a>
                                        ))
                                    ) : (
                                        <div class="content-empty">Coming soon.</div>
                                    )}
                                </div>
                            </section>

                            <section class="tab-panel" data-panel="others" hidden style="margin-top: 1rem;">
                                <div class="content-empty">Coming soon.</div>
                            </section>

                            {(authorLightning || authorNip05 || authorWebsite) && (
                                <section class="verification-section" style="margin-top: 1.5rem;">
                                    <div class="verification-header">
                                        <span>Details</span>
                                    </div>
                                    <div class="verification-grid">
                                        {authorLightning && (
                                            <div class="verification-row">
                                                <span class="verification-label">Lightning</span>
                                                <span class="verification-value">{authorLightning}</span>
                                            </div>
                                        )}
                                        {authorNip05 && (
                                            <div class="verification-row">
                                                <span class="verification-label">NIP-05</span>
                                                <span class="verification-value">{authorNip05}</span>
                                            </div>
                                        )}
                                        {authorWebsite && (
                                            <div class="verification-row">
                                                <span class="verification-label">Website</span>
                                                <span class="verification-value">{authorWebsite}</span>
                                            </div>
                                        )}
                                    </div>
                                </section>
                            )}
                        </main>
                    ) : (
                        <article role="article" itemscope itemtype="https://schema.org/Article">
                            <meta itemprop="mainEntityOfPage" content={pageUrl} />
                            
                            <header>
                                {heroImage && (
                                    <div class="hero-image">
                                        <img 
                                            src={heroImage} 
                                            alt={title} 
                                            itemprop="image"
                                        />
                                    </div>
                                )}

                                <h1 itemprop="headline">{title}</h1>

                                <div class="post-meta">
                                    <div class="post-meta-row">
                                        <time 
                                            datetime={publishedDate.toISOString()}
                                            itemprop="datePublished"
                                        >
                                            {publishedDate.toLocaleDateString("de-DE", {
                                                year: "numeric",
                                                month: "long",
                                                day: "numeric",
                                                hour: "2-digit",
                                                minute: "2-digit",
                                            })}
                                        </time>
                                        <span aria-hidden="true">•</span>
                                        <span 
                                            class="author-inline"
                                            itemprop="author" 
                                            itemscope 
                                            itemtype="https://schema.org/Person"
                                        >
                                            {authorPicture && (
                                                <img src={authorPicture} alt={authorName} itemprop="image" />
                                            )}
                                            <a href="/nostr" itemprop="url">
                                                <span itemprop="name">{authorName}</span>
                                            </a>
                                        </span>
                                        <span class="reading-time">• {readingTime} Min. Lesezeit</span>
                                        {authorLightning && (
                                            <a 
                                                href={`lightning:${authorLightning}`}
                                                class="badge badge-zap"
                                                title={`Zap an ${authorLightning}`}
                                            >
                                                Zap
                                            </a>
                                        )}
                                    </div>
                                </div>
                                
                                {summary && (
                                    <p class="summary" itemprop="description">{summary}</p>
                                )}
                            </header>

                            <div class="content" itemprop="articleBody" set:html={contentHtml} />
                            
                            <meta itemprop="wordCount" content={wordCount.toString()} />
                            <meta itemprop="inLanguage" content="de" />

                            <footer>
                                <a 
                                    href="/nostr"
                                    class="author-card"
                                >
                                    {authorPicture ? (
                                        <img 
                                            src={authorPicture} 
                                            alt={authorName} 
                                            class="author-avatar"
                                        />
                                    ) : (
                                        <div class="author-avatar-placeholder">
                                            {authorName.charAt(0).toUpperCase()}
                                        </div>
                                    )}
                                    <div class="author-details">
                                        <p class="author-name">{authorName}</p>
                                        <p class="author-npub">{authorNpub}</p>
                                    </div>
                                </a>

                                <div class="verification-section">
                                    <div class="verification-header">
                                        <span>Verifiziert auf Nostr</span>
                                    </div>
                                    
                                    <div class="verification-grid">
                                        <div class="verification-row">
                                            <span class="verification-label">Event</span>
                                            <span class="verification-value">{eventId.substring(0, 16)}...{eventId.substring(eventId.length - 8)}</span>
                                        </div>
                                        {naddr && (
                                            <div class="verification-row">
                                                <span class="verification-label">naddr</span>
                                                <span class="verification-value">{naddr.substring(0, 20)}...{naddr.substring(naddr.length - 8)}</span>
                                            </div>
                                        )}
                                        <div class="verification-row">
                                            <span class="verification-label">Relays</span>
                                            <span class="verification-value">{RELAYS.map(r => r.replace('wss://', '')).join(', ')}</span>
                                        </div>
                                    </div>

                                    <div class="verification-badges">
                                        {(naddr || nevent) && (
                                            <NostrClientPicker 
                                                code={naddr || nevent} 
                                                kind={event?.kind || 1} 
                                            />
                                        )}
                                        {naddr && (
                                            <button 
                                                class="badge"
                                                data-copy={naddr}
                                                onclick="navigator.clipboard.writeText(this.dataset.copy); this.textContent = 'Kopiert!'; setTimeout(() => this.textContent = 'naddr kopieren', 2000)"
                                            >
                                                naddr kopieren
                                            </button>
                                        )}
                                        {naddr && (
                                            <a 
                                                href={`/api/nostr/${naddr}.json`}
                                                target="_blank"
                                                rel="noopener"
                                                class="badge"
                                            >
                                                Raw JSON
                                            </a>
                                        )}
                                    </div>

                                    <div class="license-section">
                                        <a 
                                            href="https://creativecommons.org/licenses/by/4.0/deed.de"
                                            target="_blank"
                                            rel="noopener license"
                                            class="badge badge-license"
                                        >
                                            CC BY 4.0
                                        </a>
                                        <p class="license-text">
                                            Dieser Text steht frei zur Verfügung – auch kommerziell. 
                                            Bedingung: Namensnennung und Link zur Quelle.
                                        </p>
                                    </div>
                                </div>
                            </footer>
                        </article>
                    )
                )
            }
        </div>

        <script>
            const modeToggle = document.getElementById("mode-toggle");
            const modeIcon = document.getElementById("mode-icon");
            const modeText = document.getElementById("mode-text");
            const body = document.body;

            const currentMode = localStorage.getItem("theme");
            if (currentMode === "light") {
                body.classList.add("light-mode");
                modeIcon.textContent = "🌙";
                modeText.textContent = "Dark";
            }

            modeToggle?.addEventListener("click", () => {
                body.classList.toggle("light-mode");
                const isLight = body.classList.contains("light-mode");
                localStorage.setItem("theme", isLight ? "light" : "dark");
                modeIcon.textContent = isLight ? "🌙" : "☀️";
                modeText.textContent = isLight ? "Dark" : "Light";
            });

            const fontToggle = document.getElementById("font-toggle");
            const fontText = document.getElementById("font-text");
            const fonts = ["Terminal", "Sans", "Serif"];
            let currentFontIndex = 0;

            const savedFont = localStorage.getItem("font");
            if (savedFont) {
                if (savedFont === "sans") {
                    body.classList.add("font-sans");
                    currentFontIndex = 1;
                    fontText.textContent = "Sans";
                } else if (savedFont === "serif") {
                    body.classList.add("font-serif");
                    currentFontIndex = 2;
                    fontText.textContent = "Serif";
                }
            }

            fontToggle?.addEventListener("click", () => {
                currentFontIndex = (currentFontIndex + 1) % fonts.length;
                const font = fonts[currentFontIndex];

                body.classList.remove("font-sans", "font-serif");

                if (font === "Sans") {
                    body.classList.add("font-sans");
                    localStorage.setItem("font", "sans");
                } else if (font === "Serif") {
                    body.classList.add("font-serif");
                    localStorage.setItem("font", "serif");
                } else {
                    localStorage.setItem("font", "terminal");
                }

                fontText.textContent = font;
            });

            // Profile tabs (client-side switch only)
            const tabButtons = document.querySelectorAll(".profile-tabs .tab-button");
            const tabPanels = document.querySelectorAll(".tab-panel");

            tabButtons.forEach((btn) => {
                btn.addEventListener("click", () => {
                    const tab = btn.getAttribute("data-tab");
                    if (!tab) return;

                    tabButtons.forEach((b) => b.classList.toggle("is-active", b === btn));
                    tabPanels.forEach((p) => {
                        const panel = p.getAttribute("data-panel");
                        p.toggleAttribute("hidden", panel !== tab);
                    });
                });
            });
        </script>

        <script type="module" src={unlockContentUrl}></script>
    </body>
</html>
