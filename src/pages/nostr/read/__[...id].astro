---
export const prerender = false;

import { nip19, SimplePool, type Event as NostrEvent } from "nostr-tools";
import { marked } from "marked";

const { id } = Astro.params;

let event: NostrEvent | null = null;
let contentHtml = "";
let error = "";
let title = "Nostr Reader";
let authorName = "Unknown";
let authorPicture = "";
let authorNpub = "";
let authorLightning = "";
let publishedDate = new Date();
let heroImage = "";
let eventId = "";
let nevent = "";
let naddr = "";
let dTag = "";

const RELAYS = [
    "wss://relay.stevennoack.de",
    "wss://relay.primal.net",
    "wss://nos.lol",
];

if (!id) {
    return Astro.redirect("/nostr");
}

try {
    const pool = new SimplePool();

    // Decode ID and fetch event
    let filter: any = {};
    try {
        const decoded = nip19.decode(id);
        if (decoded.type === "nevent") {
            filter = { ids: [decoded.data.id] };
        } else if (decoded.type === "note") {
            filter = { ids: [decoded.data] };
        } else if (decoded.type === "naddr") {
            filter = {
                kinds: [decoded.data.kind],
                authors: [decoded.data.pubkey],
                "#d": [decoded.data.identifier],
            };
        } else {
            throw new Error("Unsupported ID type: " + decoded.type);
        }
    } catch (e) {
        // If decoding fails, assume it's a raw hex ID
        if (/^[0-9a-f]{64}$/.test(id)) {
            filter = { ids: [id] };
        } else {
            throw new Error("Invalid ID format");
        }
    }

    // Fetch event with timeout
    event = await Promise.race([
        pool.get(RELAYS, filter),
        new Promise<null>((_, reject) =>
            setTimeout(() => reject(new Error("Timeout")), 5000),
        ),
    ]);

    if (!event) {
        pool.close(RELAYS);
        error = "Event not found on relays.";
    } else {
        // Store event ID
        eventId = event.id;

        // Generate nevent
        nevent = nip19.neventEncode({
            id: event.id,
            author: event.pubkey,
            relays: RELAYS,
        });

        // Get d-tag for naddr
        const dTagEntry = event.tags.find((t) => t[0] === "d");
        if (dTagEntry) {
            dTag = dTagEntry[1];
            // Generate naddr
            naddr = nip19.naddrEncode({
                kind: event.kind,
                pubkey: event.pubkey,
                identifier: dTag,
                relays: RELAYS,
            });
        }

        // Fetch author profile (kind 0)
        try {
            const profileEvent = await Promise.race([
                pool.get(RELAYS, { kinds: [0], authors: [event.pubkey] }),
                new Promise<null>((resolve) => setTimeout(() => resolve(null), 3000)),
            ]);

            if (profileEvent) {
                const profile = JSON.parse(profileEvent.content);
                authorName = profile.display_name || profile.name || profile.username || "Unknown";
                authorPicture = profile.picture || "";
                authorLightning = profile.lud16 || profile.lud06 || "";
            } else {
                // Fallback: show shortened pubkey
                authorName = event.pubkey.substring(0, 8) + "...";
            }
        } catch (profileError) {
            // Profile fetch failed, use fallback
            console.error("Profile fetch error:", profileError);
            authorName = event.pubkey.substring(0, 8) + "...";
        }

        // Generate npub for author link
        authorNpub = nip19.npubEncode(event.pubkey);

        pool.close(RELAYS);

        // Process Event
        const content = event.content;

        // Parse Markdown (marked is safe for our use case)
        let htmlContent = await marked.parse(content);

        // Transform Callouts (Obsidian style > [!INFO])
        // All callouts are collapsed by default for cleaner reading
        htmlContent = htmlContent.replace(
            /<blockquote>\s*<p>\s*\[!(\w+)\](-?)([\s\S]*?)<\/p>([\s\S]*?)<\/blockquote>/gi,
            (match, type, collapsed, titleLine, restContent) => {
                const typeLower = type.toLowerCase();

                // Title is the first line (or part before <br> or \n)
                // If titleLine contains HTML tags like <strong>, keep them
                let titleText = titleLine.trim();

                // If there is content in the first p tag (separated by <br> or \n), append it to restContent
                const splitRegex = /(?:<br\s*\/?>|\n)/i;
                if (splitRegex.test(titleText)) {
                    const parts = titleText.split(splitRegex);
                    titleText = parts[0].trim();
                    // Re-join the rest, replacing newlines with <br> for proper rendering if needed
                    // But usually we just want to keep the rest as is, but we split by regex so we need to be careful.
                    // Actually, simpler: find index of first split match.
                    const firstSeparatorIndex = titleLine.search(splitRegex);
                    if (firstSeparatorIndex !== -1) {
                        titleText = titleLine
                            .substring(0, firstSeparatorIndex)
                            .trim();
                        const contentInP = titleLine
                            .substring(firstSeparatorIndex)
                            .replace(/^(\n|<br\s*\/?>)+/i, "");
                        restContent = contentInP + restContent;
                    }
                }

                // Default title if empty
                if (!titleText || titleText === "<br>") {
                    titleText = type.charAt(0).toUpperCase() + type.slice(1);
                }

                return `<div class="callout callout-${typeLower}">
          <details>
            <summary>${titleText}</summary>
            <div class="callout-content">${restContent}</div>
          </details>
        </div>`;
            },
        );

        contentHtml = htmlContent;

        // Metadata
        const titleTag = event.tags.find((t) => t[0] === "title");
        if (titleTag) {
            title = titleTag[1];
        } else {
            // Fallback: First line of content
            title = content.split("\n")[0].substring(0, 50) + "...";
        }

        const imageTag = event.tags.find((t) => t[0] === "image");
        if (imageTag) {
            heroImage = imageTag[1];
        }

        publishedDate = new Date(event.created_at * 1000);
    }
} catch (e) {
    console.error(e);
    error =
        "Error loading event: " + (e instanceof Error ? e.message : String(e));
}

// Schema.org Article
const articleSchema = event
    ? {
          "@context": "https://schema.org",
          "@type": "Article",
          headline: title,
          image: heroImage ? [heroImage] : undefined,
          author: {
              "@type": "Person",
              name: authorName,
              image: authorPicture || undefined,
          },
          datePublished: publishedDate.toISOString(),
          mainEntityOfPage: {
              "@type": "WebPage",
              "@id": `https://stevennoack.de/nostr/read/${id}`,
          },
      }
    : {};
---

<!doctype html>
<html lang="de">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{title} - Nostr Reader</title>

        <!-- Open Graph -->
        <meta property="og:title" content={title} />
        <meta property="og:type" content="article" />
        <meta
            property="og:url"
            content={`https://stevennoack.de/nostr/read/${id}`}
        />
        {heroImage && <meta property="og:image" content={heroImage} />}

        {
            event && (
                <>
                    <meta
                        property="article:published_time"
                        content={publishedDate.toISOString()}
                    />
                    <meta property="article:author" content={authorName} />
                    <meta name="nostr:event" content={event.id} />
                </>
            )
        }

        <script
            type="application/ld+json"
            set:html={JSON.stringify(articleSchema)}
        />

        <style is:global>
            @import "../../../styles/nostr-article.css";

            /* Badge Styles */
            .badge {
                display: inline-flex;
                align-items: center;
                gap: 0.4rem;
                padding: 0.25rem 0.6rem;
                font-size: 0.75rem;
                font-family: monospace;
                border: 1px solid rgba(0, 212, 255, 0.3);
                border-radius: 4px;
                background: transparent;
                color: #00d4ff;
                text-decoration: none;
                transition: all 0.2s ease;
                cursor: pointer;
            }

            .badge:hover {
                border-color: #00d4ff;
                background: rgba(0, 212, 255, 0.1);
            }

            .badge-zap {
                border-color: rgba(255, 200, 0, 0.4);
                color: #ffc800;
            }

            .badge-zap:hover {
                border-color: #ffc800;
                background: rgba(255, 200, 0, 0.1);
            }

            /* Author Card Styles */
            .author-card {
                display: flex;
                align-items: center;
                gap: 1rem;
                padding: 1rem;
                background: rgba(0, 212, 255, 0.05);
                border: 1px solid rgba(0, 212, 255, 0.2);
                border-radius: 8px;
                margin-top: 2rem;
                text-decoration: none;
            }

            .author-card:hover {
                border-color: rgba(0, 212, 255, 0.4);
            }

            .author-avatar {
                width: 64px;
                height: 64px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid rgba(0, 212, 255, 0.3);
            }

            .author-avatar-placeholder {
                width: 64px;
                height: 64px;
                border-radius: 50%;
                background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
                color: white;
                font-weight: bold;
            }

            .author-details {
                flex: 1;
            }

            .author-name {
                font-size: 1.1rem;
                font-weight: 600;
                color: #00d4ff;
                margin: 0 0 0.25rem 0;
            }

            .author-npub {
                font-size: 0.75rem;
                color: #666;
                font-family: monospace;
                word-break: break-all;
            }

            /* Verification Section */
            .verification-section {
                margin-top: 1.5rem;
                padding: 1rem;
                border: 1px solid rgba(0, 212, 255, 0.15);
                border-radius: 8px;
                background: rgba(0, 0, 0, 0.2);
            }

            .verification-header {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-bottom: 1rem;
                font-size: 0.8rem;
                color: #00d4ff;
                font-family: monospace;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .verification-grid {
                display: grid;
                gap: 0.75rem;
            }

            .verification-row {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                gap: 0.5rem;
            }

            .verification-label {
                font-size: 0.7rem;
                color: #666;
                font-family: monospace;
                text-transform: uppercase;
                min-width: 60px;
            }

            .verification-value {
                font-size: 0.75rem;
                color: #888;
                font-family: monospace;
                word-break: break-all;
                flex: 1;
            }

            .verification-badges {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                margin-top: 1rem;
            }

            /* Meta author inline */
            .post-meta .author-inline {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }

            .post-meta .author-inline img {
                width: 24px;
                height: 24px;
                border-radius: 50%;
                object-fit: cover;
            }

            .post-meta-row {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                gap: 0.75rem;
            }

            .light-mode .author-card {
                background: rgba(0, 150, 200, 0.05);
                border-color: rgba(0, 150, 200, 0.2);
            }

            .light-mode .author-npub {
                color: #888;
            }

            .light-mode .verification-section {
                background: rgba(0, 0, 0, 0.03);
                border-color: rgba(0, 150, 200, 0.15);
            }

            .light-mode .verification-value {
                color: #555;
            }

            .light-mode .badge {
                border-color: rgba(0, 150, 200, 0.4);
                color: #0099aa;
            }

            .light-mode .badge:hover {
                border-color: #0099aa;
                background: rgba(0, 150, 200, 0.1);
            }

            .light-mode .badge-zap {
                border-color: rgba(200, 150, 0, 0.4);
                color: #b38f00;
            }

            .light-mode .badge-zap:hover {
                border-color: #b38f00;
                background: rgba(200, 150, 0, 0.1);
            }
        </style>
    </head>
    <body>
        <!-- Font Toggle -->
        <button
            class="font-toggle"
            id="font-toggle"
            aria-label="Schriftart wechseln"
        >
            <span id="font-text">Terminal</span>
        </button>

        <!-- Dark/Light Mode Toggle -->
        <button
            class="mode-toggle"
            id="mode-toggle"
            aria-label="Dark/Light Mode umschalten"
        >
            <span id="mode-icon">‚òÄÔ∏è</span>
            <span id="mode-text">Light</span>
        </button>

        <div class="container">
            <!-- Breadcrumb Navigation -->
            <nav aria-label="Breadcrumb">
                <ol class="breadcrumb">
                    <li><a href="/">Home</a></li>
                    <li class="breadcrumb-separator" aria-hidden="true">‚Üí</li>
                    <li><a href="/nostr">Nostr</a></li>
                    <li class="breadcrumb-separator" aria-hidden="true">‚Üí</li>
                    <li aria-current="page">Reader</li>
                </ol>
            </nav>

            <a href="/nostr" class="back-link">‚Üê Zur√ºck zu Nostr</a>

            {
                error ? (
                    <div class="callout callout-summary">
                        <details open>
                            <summary>Error</summary>
                            <div class="callout-content">
                                <p>{error}</p>
                                <p>ID: {id}</p>
                            </div>
                        </details>
                    </div>
                ) : (
                    <article role="article">
                        <header>
                            {heroImage && (
                                <div class="hero-image">
                                    <img src={heroImage} alt={title} />
                                </div>
                            )}

                            <h1>{title}</h1>

                            <div class="post-meta">
                                <div class="post-meta-row">
                                    <time datetime={publishedDate.toISOString()}>
                                        {publishedDate.toLocaleDateString("de-DE", {
                                            year: "numeric",
                                            month: "long",
                                            day: "numeric",
                                            hour: "2-digit",
                                            minute: "2-digit",
                                        })}
                                    </time>
                                    <span aria-hidden="true">‚Ä¢</span>
                                    <span class="author-inline">
                                        {authorPicture && (
                                            <img src={authorPicture} alt={authorName} />
                                        )}
                                        <a href="/nostr">
                                            {authorName}
                                        </a>
                                    </span>
                                    {authorLightning && (
                                        <a 
                                            href={`lightning:${authorLightning}`}
                                            class="badge badge-zap"
                                            title={`Zap an ${authorLightning}`}
                                        >
                                            ‚ö° Zap
                                        </a>
                                    )}
                                </div>
                            </div>
                        </header>

                        <div class="content" set:html={contentHtml} />

                        <footer>
                            <a 
                                href="/nostr"
                                class="author-card"
                            >
                                {authorPicture ? (
                                    <img 
                                        src={authorPicture} 
                                        alt={authorName} 
                                        class="author-avatar"
                                    />
                                ) : (
                                    <div class="author-avatar-placeholder">
                                        {authorName.charAt(0).toUpperCase()}
                                    </div>
                                )}
                                <div class="author-details">
                                    <p class="author-name">{authorName}</p>
                                    <p class="author-npub">{authorNpub}</p>
                                </div>
                            </a>

                            <div class="verification-section">
                                <div class="verification-header">
                                    <span>‚ö°</span>
                                    <span>Verifiziert auf Nostr</span>
                                </div>
                                
                                <div class="verification-grid">
                                    <div class="verification-row">
                                        <span class="verification-label">Event</span>
                                        <span class="verification-value">{eventId.substring(0, 16)}...{eventId.substring(eventId.length - 8)}</span>
                                    </div>
                                    {naddr && (
                                        <div class="verification-row">
                                            <span class="verification-label">naddr</span>
                                            <span class="verification-value">{naddr.substring(0, 20)}...{naddr.substring(naddr.length - 8)}</span>
                                        </div>
                                    )}
                                    <div class="verification-row">
                                        <span class="verification-label">Relays</span>
                                        <span class="verification-value">{RELAYS.map(r => r.replace('wss://', '')).join(', ')}</span>
                                    </div>
                                </div>

                                <div class="verification-badges">
                                    <a 
                                        href={`https://njump.me/${nevent}`}
                                        target="_blank"
                                        rel="noopener"
                                        class="badge"
                                    >
                                        Source
                                    </a>
                                    {naddr && (
                                        <button 
                                            class="badge"
                                            data-copy={naddr}
                                            onclick="navigator.clipboard.writeText(this.dataset.copy); this.textContent = 'Kopiert!'; setTimeout(() => this.textContent = 'naddr kopieren', 2000)"
                                        >
                                            naddr kopieren
                                        </button>
                                    )}
                                    <a 
                                        href={`https://njump.me/${nevent}?json=true`}
                                        target="_blank"
                                        rel="noopener"
                                        class="badge"
                                    >
                                        Raw JSON
                                    </a>
                                </div>
                            </div>
                        </footer>
                    </article>
                )
            }
        </div>

        <script>
            // Toggle Logic (Copied from [slug].astro or we should extract this too)
            // Since we didn't extract the JS, we'll inline it here for now.
            // Ideally this should be in a shared script or layout.

            const modeToggle = document.getElementById("mode-toggle");
            const modeIcon = document.getElementById("mode-icon");
            const modeText = document.getElementById("mode-text");
            const body = document.body;

            // Check local storage
            const currentMode = localStorage.getItem("theme");
            if (currentMode === "light") {
                body.classList.add("light-mode");
                modeIcon.textContent = "üåô";
                modeText.textContent = "Dark";
            }

            modeToggle?.addEventListener("click", () => {
                body.classList.toggle("light-mode");
                const isLight = body.classList.contains("light-mode");
                localStorage.setItem("theme", isLight ? "light" : "dark");
                modeIcon.textContent = isLight ? "üåô" : "‚òÄÔ∏è";
                modeText.textContent = isLight ? "Dark" : "Light";
            });

            const fontToggle = document.getElementById("font-toggle");
            const fontText = document.getElementById("font-text");
            const fonts = ["Terminal", "Sans", "Serif"];
            let currentFontIndex = 0;

            // Check local storage
            const savedFont = localStorage.getItem("font");
            if (savedFont) {
                if (savedFont === "sans") {
                    body.classList.add("font-sans");
                    currentFontIndex = 1;
                    fontText.textContent = "Sans";
                } else if (savedFont === "serif") {
                    body.classList.add("font-serif");
                    currentFontIndex = 2;
                    fontText.textContent = "Serif";
                }
            }

            fontToggle?.addEventListener("click", () => {
                currentFontIndex = (currentFontIndex + 1) % fonts.length;
                const font = fonts[currentFontIndex];

                body.classList.remove("font-sans", "font-serif");

                if (font === "Sans") {
                    body.classList.add("font-sans");
                    localStorage.setItem("font", "sans");
                } else if (font === "Serif") {
                    body.classList.add("font-serif");
                    localStorage.setItem("font", "serif");
                } else {
                    localStorage.setItem("font", "terminal");
                }

                fontText.textContent = font;
            });
        </script>
    </body>
</html>
