---
/**
 * Nostr Artikel Template - LLM Optimized
 * @description Long-form Artikel (Kind 30023) mit Schema.org Article
 */
import { getCollection } from "astro:content";
import { nip19 } from "nostr-tools";

export async function getStaticPaths() {
  const articles = await getCollection("nostr-artikel");
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

const { article } = Astro.props;
const { Content } = await article.render();

// Convert date strings to Date objects
const articleDate = new Date(article.data.date);
const modifiedDate = article.data.modified ? new Date(article.data.modified) : articleDate;

// Constants
const SITE_URL = "https://stevennoack.de";
const SITE_NAME = "Steven Noack";
const AUTHOR_PUBKEY = "c1baf4f74cd829963828b1da8d73e52cc94caa6d8dc944f7ca450a75c4b3311f";
const AUTHOR_NPUB = "npub1cxa0fa6vmq5evwpgk8dg6ul99ny5e2nd3hy5fa72g598t39nxy0surzuva";
const RELAYS = [
  "wss://relay.stevennoack.de",
  "wss://relay.primal.net", 
  "wss://nos.lol",
];

// Generate naddr for this article
const naddr = nip19.naddrEncode({
  kind: 30023,
  pubkey: AUTHOR_PUBKEY,
  identifier: article.slug,
  relays: RELAYS,
});

const pageUrl = `${SITE_URL}/nostr/artikel/${article.slug}`;
const dynamicUrl = `${SITE_URL}/nostr/read/${naddr}`;
const jsonApiUrl = `${SITE_URL}/api/nostr/${naddr}.json`;

// Calculate word count and reading time
const content = article.body || "";
const wordCount = content.split(/\s+/).filter(word => word.length > 0).length;
const readingTime = Math.ceil(wordCount / 200);

// ============================================
// COMPREHENSIVE SCHEMA.ORG + KNOWLEDGE GRAPH
// ============================================

// Person Schema (Author)
const authorSchema = {
  "@type": "Person",
  "@id": `${SITE_URL}/#author`,
  name: article.data.author || "Steven Noack",
  url: `${SITE_URL}/nostr`,
  image: "https://stevennoack.de/images/steven-noack.jpg",
  description: "System Builder. Dekonditionierung f√ºr Mensch und Maschine.",
  identifier: [
    {
      "@type": "PropertyValue",
      propertyID: "nostr:npub",
      value: AUTHOR_NPUB,
    },
    {
      "@type": "PropertyValue",
      propertyID: "nostr:nip05",
      value: "steven@stevennoack.de",
    },
  ],
  sameAs: [
    `https://njump.me/${AUTHOR_NPUB}`,
    SITE_URL,
    "https://github.com/MacStenk",
  ],
};

// Organization Schema (Publisher)
const publisherSchema = {
  "@type": "Organization",
  "@id": `${SITE_URL}/#organization`,
  name: SITE_NAME,
  url: SITE_URL,
  logo: {
    "@type": "ImageObject",
    url: `${SITE_URL}/favicon.svg`,
    width: 512,
    height: 512,
  },
  sameAs: [
    `https://njump.me/${AUTHOR_NPUB}`,
    "https://github.com/MacStenk",
  ],
};

// ImageObject Schema (Hero Image)
const imageSchema = article.data.heroImage ? {
  "@type": "ImageObject",
  "@id": `${pageUrl}/#primaryimage`,
  url: article.data.heroImage,
  contentUrl: article.data.heroImage,
  caption: article.data.title,
  representativeOfPage: true,
} : null;

// BreadcrumbList Schema
const breadcrumbSchema = {
  "@type": "BreadcrumbList",
  "@id": `${pageUrl}/#breadcrumb`,
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Home",
      item: SITE_URL,
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Nostr",
      item: `${SITE_URL}/nostr`,
    },
    {
      "@type": "ListItem",
      position: 3,
      name: article.data.title,
      item: pageUrl,
    },
  ],
};

// WebPage Schema
const webPageSchema = {
  "@type": "WebPage",
  "@id": pageUrl,
  url: pageUrl,
  name: `${article.data.title} - ${SITE_NAME}`,
  description: article.data.description,
  isPartOf: { "@id": `${SITE_URL}/#website` },
  primaryImageOfPage: imageSchema ? { "@id": `${pageUrl}/#primaryimage` } : undefined,
  breadcrumb: { "@id": `${pageUrl}/#breadcrumb` },
  inLanguage: "de-DE",
  potentialAction: [
    {
      "@type": "ReadAction",
      target: [pageUrl],
    },
  ],
};

// Website Schema
const websiteSchema = {
  "@type": "WebSite",
  "@id": `${SITE_URL}/#website`,
  url: SITE_URL,
  name: SITE_NAME,
  description: "Dekonditionierung. F√ºr Mensch und Maschine.",
  publisher: { "@id": `${SITE_URL}/#organization` },
  inLanguage: "de-DE",
};

// Main Article Schema - Umfangreich
const articleSchema = {
  "@type": "Article",
  "@id": `${pageUrl}/#article`,
  headline: article.data.title,
  name: article.data.title,
  description: article.data.description,
  image: imageSchema ? { "@id": `${pageUrl}/#primaryimage` } : undefined,
  author: { "@id": `${SITE_URL}/#author` },
  publisher: { "@id": `${SITE_URL}/#organization` },
  datePublished: articleDate.toISOString(),
  dateModified: modifiedDate.toISOString(),
  dateCreated: articleDate.toISOString(),
  mainEntityOfPage: { "@id": pageUrl },
  isPartOf: { "@id": `${SITE_URL}/#website` },
  inLanguage: "de-DE",
  wordCount: wordCount,
  timeRequired: `PT${readingTime}M`,
  keywords: article.data.tags?.join(", ") || "",
  articleSection: article.data.category || "Nostr",
  isAccessibleForFree: true,
  license: "https://creativecommons.org/licenses/by/4.0/",
  copyrightYear: articleDate.getFullYear(),
  copyrightHolder: { "@id": `${SITE_URL}/#author` },
  
  // Nostr-spezifische Identifier
  identifier: [
    {
      "@type": "PropertyValue",
      propertyID: "nostr:naddr",
      value: naddr,
    },
    {
      "@type": "PropertyValue",
      propertyID: "nostr:d-tag",
      value: article.slug,
    },
  ],
  
  // Verkn√ºpfung zu anderen Versionen (dynamische Seite ist Kopie, njump ist Verifizierung)
  sameAs: [
    `https://njump.me/${naddr}`,
  ],
  
  // Relays als distribution
  distribution: RELAYS.map(relay => ({
    "@type": "DataDownload",
    contentUrl: relay,
    encodingFormat: "application/json",
    description: `Nostr Relay: ${relay}`,
  })),
};

// Combined Graph - Alle Schemas verkn√ºpft
const schemaGraph = {
  "@context": "https://schema.org",
  "@graph": [
    websiteSchema,
    publisherSchema,
    authorSchema,
    imageSchema,
    breadcrumbSchema,
    webPageSchema,
    articleSchema,
  ].filter(Boolean),
};
---

<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{article.data.title} - Steven Noack</title>
    <meta name="description" content={article.data.description} />
    <meta name="author" content={article.data.author || "Steven Noack"} />
    <meta name="keywords" content={article.data.tags?.join(", ")} />
    <meta name="robots" content="index, follow" />

    <!-- Canonical -->
    <link rel="canonical" href={pageUrl} />
    
    <!-- Alternate Formats -->
    <link rel="alternate" type="application/json" href={jsonApiUrl} title="JSON (Nostr Event)" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article" />
    <meta property="og:url" content={pageUrl} />
    <meta property="og:title" content={article.data.title} />
    <meta property="og:description" content={article.data.description} />
    <meta property="og:image" content={article.data.ogImage || article.data.heroImage} />
    <meta property="og:site_name" content={SITE_NAME} />
    <meta property="og:locale" content="de_DE" />
    <meta property="article:published_time" content={articleDate.toISOString()} />
    <meta property="article:modified_time" content={modifiedDate.toISOString()} />
    <meta property="article:author" content={article.data.author || "Steven Noack"} />
    {article.data.tags?.map((tag) => (
      <meta property="article:tag" content={tag} />
    ))}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={pageUrl} />
    <meta name="twitter:title" content={article.data.title} />
    <meta name="twitter:description" content={article.data.description} />
    <meta name="twitter:image" content={article.data.ogImage || article.data.heroImage} />

    <!-- Nostr Meta -->
    <meta name="nostr:author" content={AUTHOR_NPUB} />
    <meta name="nostr:nip05" content="steven@stevennoack.de" />
    <meta name="nostr:naddr" content={naddr} />
    <meta name="nostr:d-tag" content={article.slug} />

    <!-- Schema.org JSON-LD (Knowledge Graph) -->
    <script type="application/ld+json" set:html={JSON.stringify(schemaGraph)} />

    <style is:global>
      @import "../../../styles/nostr-article.css";

      /* Verification Section */
      .verification-section {
        margin-top: 2rem;
        padding: 1rem;
        border: 1px solid rgba(0, 212, 255, 0.15);
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.2);
      }

      .verification-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.8rem;
        color: #00d4ff;
        font-family: monospace;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .verification-grid {
        display: grid;
        gap: 0.75rem;
      }

      .verification-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem;
      }

      .verification-label {
        font-size: 0.7rem;
        color: #666;
        font-family: monospace;
        text-transform: uppercase;
        min-width: 60px;
      }

      .verification-value {
        font-size: 0.75rem;
        color: #888;
        font-family: monospace;
        word-break: break-all;
        flex: 1;
      }

      .verification-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      /* Badge Styles */
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.25rem 0.6rem;
        font-size: 0.75rem;
        font-family: monospace;
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 4px;
        background: transparent;
        color: #00d4ff;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .badge:hover {
        border-color: #00d4ff;
        background: rgba(0, 212, 255, 0.1);
      }

      /* License Section */
      .license-section {
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(0, 212, 255, 0.1);
      }

      .badge-license {
        border-color: rgba(100, 200, 100, 0.4);
        color: #64c864;
      }

      .badge-license:hover {
        border-color: #64c864;
        background: rgba(100, 200, 100, 0.1);
      }

      .license-text {
        margin-top: 0.75rem;
        font-size: 0.75rem;
        color: #666;
        line-height: 1.5;
      }

      /* Light mode */
      .light-mode .verification-section {
        background: rgba(0, 0, 0, 0.03);
        border-color: rgba(0, 150, 200, 0.15);
      }

      .light-mode .verification-value {
        color: #555;
      }

      .light-mode .badge {
        border-color: rgba(0, 150, 200, 0.4);
        color: #0099aa;
      }

      .light-mode .badge:hover {
        border-color: #0099aa;
        background: rgba(0, 150, 200, 0.1);
      }

      .light-mode .badge-license {
        border-color: rgba(80, 160, 80, 0.4);
        color: #4a9a4a;
      }

      .light-mode .badge-license:hover {
        border-color: #4a9a4a;
        background: rgba(80, 160, 80, 0.1);
      }

      .light-mode .license-text {
        color: #555;
      }
    </style>
  </head>
</html>
<body>
  <!-- Font Toggle -->
  <button class="font-toggle" id="font-toggle" aria-label="Schriftart wechseln">
    <span id="font-text">Terminal</span>
  </button>

  <!-- Dark/Light Mode Toggle -->
  <button
    class="mode-toggle"
    id="mode-toggle"
    aria-label="Dark/Light Mode umschalten"
  >
    <span id="mode-icon">‚òÄÔ∏è</span>
    <span id="mode-text">Light</span>
  </button>

  <div class="container">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="Breadcrumb">
      <ol class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a itemprop="item" href="/"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <li class="breadcrumb-separator" aria-hidden="true">‚Üí</li>
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a itemprop="item" href="/nostr"><span itemprop="name">Nostr</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <li class="breadcrumb-separator" aria-hidden="true">‚Üí</li>
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" aria-current="page">
          <span itemprop="name">{article.data.title}</span>
          <meta itemprop="position" content="3" />
        </li>
      </ol>
    </nav>

    <a href="/nostr" class="back-link">‚Üê Zur√ºck zu Nostr</a>

    <!-- Main Article -->
    <article role="article" aria-labelledby="article-title" itemscope itemtype="https://schema.org/Article">
      <meta itemprop="mainEntityOfPage" content={pageUrl} />
      
      <!-- Hero Image -->
      {
        article.data.heroImage && (
          <div class="hero-image">
            <img
              src={article.data.heroImage}
              alt={article.data.heroImageAlt || article.data.title}
              itemprop="image"
            />
            {article.data.heroImageCaption && (
              <p class="hero-caption">{article.data.heroImageCaption}</p>
            )}
          </div>
        )
      }

      <!-- Article Header -->
      <header>
        <!-- Nostr Badge -->
        <div class="nostr-badge">
          ‚ö° Live from Nostr
          <a
            href={dynamicUrl}
            rel="noopener"
          >
            [Source]
          </a>
        </div>

        <h1 id="article-title" itemprop="headline">{article.data.title}</h1>

        {
          article.data.subtitle && (
            <p class="subtitle">{article.data.subtitle}</p>
          )
        }

        <div class="post-meta">
          <time datetime={articleDate.toISOString()} itemprop="datePublished">
            {
              articleDate.toLocaleDateString("de-DE", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })
            }
          </time>
          <span aria-hidden="true">‚Ä¢</span>
          <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <span itemprop="name">{article.data.author || "Steven Noack"}</span>
          </span>
          <span aria-hidden="true">‚Ä¢</span>
          <span>{readingTime} Min. Lesezeit</span>
        </div>

        {
          article.data.tags && article.data.tags.length > 0 && (
            <div class="post-tags" role="list" aria-label="Artikel-Tags">
              {article.data.tags.map((tag) => (
                <span class="tag" role="listitem">
                  {tag}
                </span>
              ))}
            </div>
          )
        }

        {
          article.data.series && (
            <div class="series-info">
              Serie: {article.data.series}
              {article.data.part && ` ‚Äì Teil ${article.data.part}`}
            </div>
          )
        }
      </header>

      <!-- Article Content -->
      <section class="content" aria-label="Artikel-Inhalt" itemprop="articleBody">
        <Content />
      </section>
      
      <meta itemprop="wordCount" content={wordCount.toString()} />
      <meta itemprop="inLanguage" content="de" />

      <!-- Article Footer -->
      <footer>
        <div class="author-info">
          <span>Autor: {article.data.author || "Steven Noack"}</span>
          <span>
            NIP-05: <a href={`https://njump.me/${AUTHOR_NPUB}`}>steven@stevennoack.de</a>
          </span>
          <span>
            Nostr: <a href="/nostr">stevennoack.de/nostr</a>
          </span>
        </div>

        <!-- Verification Section -->
        <div class="verification-section">
          <div class="verification-header">
            <span>‚ö°</span>
            <span>Verifiziert auf Nostr</span>
          </div>
          
          <div class="verification-grid">
            <div class="verification-row">
              <span class="verification-label">naddr</span>
              <span class="verification-value">{naddr.substring(0, 20)}...{naddr.substring(naddr.length - 8)}</span>
            </div>
            <div class="verification-row">
              <span class="verification-label">d-tag</span>
              <span class="verification-value">{article.slug}</span>
            </div>
            <div class="verification-row">
              <span class="verification-label">Relays</span>
              <span class="verification-value">{RELAYS.map(r => r.replace('wss://', '')).join(', ')}</span>
            </div>
          </div>

          <div class="verification-badges">
            <a 
              href={`https://habla.news/a/${naddr}`}
              target="_blank"
              rel="noopener"
              class="badge"
            >
              Source
            </a>
            <a 
              href={dynamicUrl}
              class="badge"
            >
              Live Reader
            </a>
            <button 
              class="badge"
              data-copy={naddr}
              id="copy-naddr"
            >
              naddr kopieren
            </button>
            <a 
              href={jsonApiUrl}
              target="_blank"
              rel="noopener"
              class="badge"
            >
              Raw JSON
            </a>
          </div>

          <div class="license-section">
            <a 
              href="https://creativecommons.org/licenses/by/4.0/deed.de"
              target="_blank"
              rel="noopener license"
              class="badge badge-license"
            >
              CC BY 4.0
            </a>
            <p class="license-text">
              Dieser Text steht frei zur Verf√ºgung ‚Äì auch kommerziell. 
              Bedingung: Namensnennung und Link zur Quelle.
            </p>
          </div>
        </div>
      </footer>
    </article>
  </div>

  <!-- Scripts -->
  <script>
    const savedMode = localStorage.getItem("colorMode") || "dark";
    const body = document.body;
    const toggle = document.getElementById("mode-toggle");
    const modeIcon = document.getElementById("mode-icon");
    const modeText = document.getElementById("mode-text");

    if (savedMode === "light") {
      body.classList.add("light-mode");
      modeIcon.textContent = "üåô";
      modeText.textContent = "Dark";
    }

    toggle.addEventListener("click", () => {
      body.classList.toggle("light-mode");
      const isLight = body.classList.contains("light-mode");
      if (isLight) {
        modeIcon.textContent = "üåô";
        modeText.textContent = "Dark";
        localStorage.setItem("colorMode", "light");
      } else {
        modeIcon.textContent = "‚òÄÔ∏è";
        modeText.textContent = "Light";
        localStorage.setItem("colorMode", "dark");
      }
    });
  </script>

  <script>
    const fontBody = document.body;
    const savedFont = localStorage.getItem("fontStyle") || "terminal";
    const fontToggle = document.getElementById("font-toggle");
    const fontText = document.getElementById("font-text");

    const fonts = ["terminal", "sans", "serif"];
    const fontNames = { terminal: "Terminal", sans: "Sans", serif: "Serif" };

    let currentFontIndex = fonts.indexOf(savedFont);

    if (savedFont === "sans") {
      fontBody.classList.add("font-sans");
      fontText.textContent = "Sans";
    } else if (savedFont === "serif") {
      fontBody.classList.add("font-serif");
      fontText.textContent = "Serif";
    }

    fontToggle.addEventListener("click", () => {
      fontBody.classList.remove("font-sans", "font-serif");
      currentFontIndex = (currentFontIndex + 1) % fonts.length;
      const newFont = fonts[currentFontIndex];
      if (newFont === "sans") fontBody.classList.add("font-sans");
      else if (newFont === "serif") fontBody.classList.add("font-serif");
      fontText.textContent = fontNames[newFont];
      localStorage.setItem("fontStyle", newFont);
    });
  </script>

  <!-- Copy naddr -->
  <script>
    const copyBtn = document.getElementById("copy-naddr");
    if (copyBtn) {
      copyBtn.addEventListener("click", () => {
        const naddr = copyBtn.dataset.copy;
        navigator.clipboard.writeText(naddr);
        copyBtn.textContent = "Kopiert!";
        setTimeout(() => {
          copyBtn.textContent = "naddr kopieren";
        }, 2000);
      });
    }
  </script>

  <!-- Obsidian Callouts ‚Üí Collapsible -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const blockquotes = document.querySelectorAll(".content blockquote");

      blockquotes.forEach((bq) => {
        const firstP = bq.querySelector("p:first-child");
        if (!firstP) return;

        const text = firstP.innerHTML;
        const calloutMatch = text.match(/^\[!(\w+)\](-)?/);
        if (!calloutMatch) return;

        const calloutType = calloutMatch[1].toLowerCase();
        const isCollapsed = calloutMatch[2] === "-";

        let title;
        const afterMarker = text.replace(/^\[!\w+\]-?\s*/, "");
        const boldMatch = afterMarker.match(/^\*\*(.+?)\*\*/);

        if (boldMatch) {
          title = boldMatch[1];
        } else {
          const plainMatch = afterMarker.match(/^([^<]+)/);
          title = plainMatch
            ? plainMatch[1].trim()
            : calloutType.charAt(0).toUpperCase() + calloutType.slice(1);
        }

        if (!title)
          title = calloutType.charAt(0).toUpperCase() + calloutType.slice(1);

        const details = document.createElement("details");
        details.className = "callout callout-" + calloutType;
        if (!isCollapsed) details.open = true;

        const summary = document.createElement("summary");
        summary.innerHTML = title;

        const content = document.createElement("div");
        content.className = "callout-content";

        const children = Array.from(bq.children);
        children.forEach((child, index) => {
          if (index === 0) {
            let cleanedHTML = child.innerHTML;
            cleanedHTML = cleanedHTML.replace(
              /^\[!\w+\]-?\s*\*\*(.+?)\*\*\s*/,
              "",
            );
            cleanedHTML = cleanedHTML.replace(/^\[!\w+\]-?\s*[^<]+/, "");
            cleanedHTML = cleanedHTML.replace(/^<br\s*\/?>\s*/, "").trim();
            if (cleanedHTML) {
              const div = document.createElement("div");
              div.innerHTML = cleanedHTML;
              content.appendChild(div);
            }
          } else {
            content.appendChild(child.cloneNode(true));
          }
        });

        details.appendChild(summary);
        details.appendChild(content);
        bq.parentNode.replaceChild(details, bq);
      });
    });
  </script>
</body>
